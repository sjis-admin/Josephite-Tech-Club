<!-- templates/admin/event_list.html -->
{% extends 'base.html' %}

{% block title %}Event Management - Josephite Tech Club{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="flex items-center justify-between p-6">
            <h1 class="text-3xl font-bold text-gray-800">
                <i class="fas fa-calendar text-primary mr-2"></i>
                Event Management
            </h1>
            <div class="flex items-center space-x-4">
                <span class="text-gray-600">{{ events.count }} Total Events</span>
                <a href="{% url 'admin_dashboard' %}" class="text-primary hover:text-blue-700 transition-colors">
                    <i class="fas fa-arrow-left mr-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="bg-white border-b">
        <nav class="flex space-x-8 px-6">
            <a href="{% url 'admin_dashboard' %}" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors">
                <i class="fas fa-home mr-1"></i>Dashboard
            </a>
            <a href="{% url 'admin_students' %}" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors">
                <i class="fas fa-users mr-1"></i>Students
            </a>
            <a href="{% url 'admin_payments' %}" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors">
                <i class="fas fa-credit-card mr-1"></i>Payments
            </a>
            <a href="{% url 'admin_events' %}" class="py-4 px-1 border-b-2 border-primary text-primary font-medium">
                <i class="fas fa-calendar mr-1"></i>Events
            </a>
            <a href="{% url 'admin_reports' %}" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors">
                <i class="fas fa-chart-bar mr-1"></i>Reports
            </a>
            <a href="{% url 'admin_logs' %}" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors">
                <i class="fas fa-history mr-1"></i>Logs
            </a>
        </nav>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 p-6">
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-calendar-plus text-3xl text-blue-500"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 uppercase tracking-wide">Total Events</dt>
                        <dd class="text-2xl font-bold text-gray-900">{{ events.count }}</dd>
                    </dl>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-check-circle text-3xl text-green-500"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 uppercase tracking-wide">Active Events</dt>
                        <dd class="text-2xl font-bold text-gray-900">{{ active_events_count }}</dd>
                    </dl>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-users text-3xl text-purple-500"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 uppercase tracking-wide">Total Registrations</dt>
                        <dd class="text-2xl font-bold text-gray-900">
                            {% for event in events %}{{ event.registration_count|add:0 }}{% empty %}0{% endfor %}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-500">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-money-bill-wave text-3xl text-yellow-500"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 uppercase tracking-wide">Event Revenue</dt>
                        <dd class="text-2xl font-bold text-gray-900">
                            ৳{{ total_revenue|floatformat:0 }}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New Event Button -->
    <div class="px-6 mb-6">
        <a href="/admin/registration/event/add/" class="inline-flex items-center px-4 py-2 bg-primary text-white font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm">
            <i class="fas fa-plus mr-2"></i>Add New Event
        </a>
    </div>

    <!-- Events Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 px-6 pb-6">
        {% for event in events %}
        <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:scale-105">
            <!-- Event Header -->
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-6 text-white relative overflow-hidden">
                <div class="absolute inset-0 bg-black opacity-10"></div>
                <div class="relative z-10">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xl font-bold truncate">{{ event.name }}</h3>
                        {% if event.is_active %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 bg-opacity-90">
                                <div class="w-1.5 h-1.5 bg-green-400 rounded-full mr-1 animate-pulse"></div>
                                Active
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 bg-opacity-90">
                                <div class="w-1.5 h-1.5 bg-red-400 rounded-full mr-1"></div>
                                Inactive
                            </span>
                        {% endif %}
                    </div>
                    <div class="text-2xl font-bold">৳{{ event.fee|floatformat:0 }}</div>
                    <div class="text-blue-100 text-sm">Registration Fee</div>
                </div>
                <!-- Decorative elements -->
                <div class="absolute top-0 right-0 -mt-4 -mr-4 w-16 h-16 bg-white opacity-10 rounded-full"></div>
                <div class="absolute bottom-0 left-0 -mb-4 -ml-4 w-12 h-12 bg-white opacity-10 rounded-full"></div>
            </div>

            <!-- Event Content -->
            <div class="p-6">
                <div class="mb-4">
                    <p class="text-gray-600 text-sm line-clamp-3">
                        {{ event.description|truncatechars:120 }}
                    </p>
                </div>

                <!-- Statistics -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-blue-600">{{ event.registration_count|default:0 }}</div>
                        <div class="text-xs text-blue-500 uppercase tracking-wide">Registrations</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-green-600">৳{{ event.total_revenue|default:0|floatformat:0 }}</div>
                        <div class="text-xs text-green-500 uppercase tracking-wide">Revenue</div>
                    </div>
                </div>

                <!-- Event Details -->
                <div class="space-y-2 mb-6">
                    <div class="flex items-center text-sm text-gray-600">
                        <i class="fas fa-calendar-alt w-4 h-4 mr-2 text-gray-400"></i>
                        <span>Created: {{ event.created_at|date:"M j, Y" }}</span>
                    </div>
                    <div class="flex items-center text-sm text-gray-600">
                        <i class="fas fa-clock w-4 h-4 mr-2 text-gray-400"></i>
                        <span>Last updated: {{ event.created_at|timesince }} ago</span>
                    </div>
                    <div class="flex items-center text-sm text-gray-600">
                        <i class="fas fa-info-circle w-4 h-4 mr-2 text-gray-400"></i>
                        <span>
                            {% if event.event_type == 'TEAM' %}
                                Team Event (Max: {{ event.max_team_size }} members)
                            {% else %}
                                Individual Event
                            {% endif %}
                        </span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center justify-between space-x-2">
                    <div class="flex space-x-2">
                        <a href="/admin/registration/event/{{ event.id }}/change/" 
                           class="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-700 text-sm font-medium rounded-md hover:bg-blue-200 transition-colors">
                            <i class="fas fa-edit mr-1"></i>Edit
                        </a>
                        <button onclick="viewEventDetails({{ event.id }})" 
                                class="inline-flex items-center px-3 py-1 bg-green-100 text-green-700 text-sm font-medium rounded-md hover:bg-green-200 transition-colors">
                            <i class="fas fa-eye mr-1"></i>View
                        </button>
                    </div>
                    <div class="flex items-center space-x-1">
                        {% if event.is_active %}
                        <button onclick="toggleEventStatus({{ event.id }}, false)" 
                                class="p-2 text-yellow-600 hover:bg-yellow-50 rounded-md transition-colors" title="Deactivate Event">
                            <i class="fas fa-pause"></i>
                        </button>
                        {% else %}
                        <button onclick="toggleEventStatus({{ event.id }}, true)" 
                                class="p-2 text-green-600 hover:bg-green-50 rounded-md transition-colors" title="Activate Event">
                            <i class="fas fa-play"></i>
                        </button>
                        {% endif %}
                        <button onclick="confirmDeleteEvent({{ event.id }}, '{{ event.name }}')" 
                                class="p-2 text-red-600 hover:bg-red-50 rounded-md transition-colors" title="Delete Event">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Registration Progress Bar -->
            {% if event.registration_count > 0 %}
            <div class="bg-gray-50 px-6 py-3">
                <div class="flex items-center justify-between text-xs text-gray-600 mb-1">
                    <span>Registration Progress</span>
                    <span>{{ event.registration_count }} students</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-500"
                         style="width: {% if event.registration_count %}{% widthratio event.registration_count 100 100 %}{% else %}0{% endif %}%;"></div>
                </div>
            </div>
            {% endif %}
        </div>
        {% empty %}
        <div class="col-span-full">
            <div class="bg-white rounded-xl shadow-lg p-12 text-center">
                <div class="text-gray-500">
                    <i class="fas fa-calendar-plus text-6xl mb-6"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">No Events Created</h3>
                    <p class="text-gray-500 mb-6">Get started by creating your first event for the tech carnival.</p>
                    <a href="/admin/registration/event/add/" 
                       class="inline-flex items-center px-6 py-3 bg-primary text-white font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm">
                        <i class="fas fa-plus mr-2"></i>Create Your First Event
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Event Details Modal -->
<div id="eventDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="eventModalTitle">Event Details</h3>
                <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mt-2 px-7 py-3" id="eventModalContent">
                <!-- Event details will be loaded here -->
            </div>
            <div class="items-center px-4 py-3">
                <button onclick="closeEventModal()" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteEventModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <i class="fas fa-exclamation-triangle text-red-600"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900">Delete Event</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500" id="deleteEventMessage">
                    Are you sure you want to delete this event? This action cannot be undone.
                </p>
            </div>
            <div class="items-center px-4 py-3">
                <button id="confirmDeleteEventBtn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300 mr-2">
                    Delete
                </button>
                <button onclick="closeDeleteEventModal()" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let eventToDelete = null;

// Event details data
const eventsData = {
    {% for event in events %}
    {{ event.id }}: {
        name: "{{ event.name|escapejs }}",
        description: "{{ event.description|escapejs }}",
        fee: "{{ event.fee }}",
        is_active: {{ event.is_active|yesno:"true,false" }},
        created_at: "{{ event.created_at|date:"M j, Y g:i A" }}",
        registrations: {{ event.registration_count|default:0 }},
        revenue: {{ event.total_revenue|default:0 }},
        event_type: "{{ event.get_event_type_display }}",
        max_team_size: "{{ event.max_team_size|default:'' }}"
    },
    {% endfor %}
};

function viewEventDetails(eventId) {
    const event = eventsData[eventId];
    if (!event) return;

    document.getElementById('eventModalTitle').textContent = event.name;
    document.getElementById('eventModalContent').innerHTML = `
        <div class="space-y-4">
            <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="font-medium text-gray-900 mb-2">Description</h4>
                <p class="text-gray-700">${event.description}</p>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-medium text-blue-900 mb-1">Registration Fee</h4>
                    <p class="text-2xl font-bold text-blue-600">৳${parseFloat(event.fee).toLocaleString()}</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <h4 class="font-medium text-green-900 mb-1">Status</h4>
                    <p class="text-lg font-semibold ${event.is_active ? 'text-green-600' : 'text-red-600'}">
                        ${event.is_active ? 'Active' : 'Inactive'}
                    </p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-purple-50 p-4 rounded-lg">
                    <h4 class="font-medium text-purple-900 mb-1">Total Registrations</h4>
                    <p class="text-2xl font-bold text-purple-600">${event.registrations}</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <h4 class="font-medium text-yellow-900 mb-1">Total Revenue</h4>
                    <p class="text-2xl font-bold text-yellow-600">৳${parseFloat(event.revenue).toLocaleString()}</p>
                </div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="font-medium text-gray-900 mb-2">Event Type</h4>
                <p class="text-gray-700">${event.event_type}${event.max_team_size ? ` (Max: ${event.max_team_size} members)` : ''}</p>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="font-medium text-gray-900 mb-2">Created</h4>
                <p class="text-gray-700">${event.created_at}</p>
            </div>
        </div>
    `;
    
    document.getElementById('eventDetailsModal').classList.remove('hidden');
}

function closeEventModal() {
    document.getElementById('eventDetailsModal').classList.add('hidden');
}

function toggleEventStatus(eventId, newStatus) {
    const action = newStatus ? 'activate' : 'deactivate';
    if (confirm(`Are you sure you want to ${action} this event?`)) {
        // Here you would make an AJAX call to toggle the status
        // For now, we'll show a message and reload
        alert(`Event ${action}d! (This would be handled via AJAX in a real implementation)`);
        // window.location.reload();
    }
}

function confirmDeleteEvent(eventId, eventName) {
    eventToDelete = eventId;
    document.getElementById('deleteEventMessage').textContent = 
        `Are you sure you want to delete "${eventName}"? This action cannot be undone and will affect all registrations for this event.`;
    document.getElementById('deleteEventModal').classList.remove('hidden');
}

function closeDeleteEventModal() {
    document.getElementById('deleteEventModal').classList.add('hidden');
    eventToDelete = null;
}

document.getElementById('confirmDeleteEventBtn').addEventListener('click', function() {
    if (eventToDelete) {
        // Here you would make an AJAX call to delete the event
        // For now, we'll redirect to Django admin delete page
        window.location.href = `/admin/registration/event/${eventToDelete}/delete/`;
    }
});
</script>
{% endblock %}

// Close modals when clicking outside
document.getElementById('eventDetailsModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeEventModal();
    }
});

document.getElementById('deleteEventModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteEventModal();
    }
});

// Add animation classes after page load
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.transform');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            setTimeout(() => {
                card.style.transition = 'all 0.6s ease-out';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 100);
        }, index * 100);
    });
});